<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/switch.css">
    <link rel="stylesheet" type="text/css" href="css/theme.css">
    <link rel="stylesheet" type="text/css" href="css/centered_square_game.css">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css" />
    <style type="text/css"></style>
  </head>
  <body>
    <div class="container">
      <div class="square">
        <div id="game_table" class="centered">
          <div id="inner-game-A" class="inner-game a">
            <div class="inner-game-container">
              <div class="inner-game-square a" data-game-index="0" data-subgame-index="0"></div>
              <div class="inner-game-square b" data-game-index="0" data-subgame-index="1"></div>
              <div class="inner-game-square c" data-game-index="0" data-subgame-index="2"></div>
              <div class="inner-game-square d" data-game-index="0" data-subgame-index="3"></div>
              <div class="inner-game-square e" data-game-index="0" data-subgame-index="4"></div>
              <div class="inner-game-square f" data-game-index="0" data-subgame-index="5"></div>
              <div class="inner-game-square g" data-game-index="0" data-subgame-index="6"></div>
              <div class="inner-game-square h" data-game-index="0" data-subgame-index="7"></div>
              <div class="inner-game-square i" data-game-index="0" data-subgame-index="8"></div>
            </div>
          </div>
          <div id="inner-game-B" class="inner-game b">
            <div class="inner-game-container">
              <div class="inner-game-square a" data-game-index="1" data-subgame-index="0"></div>
              <div class="inner-game-square b" data-game-index="1" data-subgame-index="1"></div>
              <div class="inner-game-square c" data-game-index="1" data-subgame-index="2"></div>
              <div class="inner-game-square d" data-game-index="1" data-subgame-index="3"></div>
              <div class="inner-game-square e" data-game-index="1" data-subgame-index="4"></div>
              <div class="inner-game-square f" data-game-index="1" data-subgame-index="5"></div>
              <div class="inner-game-square g" data-game-index="1" data-subgame-index="6"></div>
              <div class="inner-game-square h" data-game-index="1" data-subgame-index="7"></div>
              <div class="inner-game-square i" data-game-index="1" data-subgame-index="8"></div>
            </div>
          </div>
          <div id="inner-game-C" class="inner-game c">
            <div class="inner-game-container">
              <div class="inner-game-square a" data-game-index="2" data-subgame-index="0"></div>
              <div class="inner-game-square b" data-game-index="2" data-subgame-index="1"></div>
              <div class="inner-game-square c" data-game-index="2" data-subgame-index="2"></div>
              <div class="inner-game-square d" data-game-index="2" data-subgame-index="3"></div>
              <div class="inner-game-square e" data-game-index="2" data-subgame-index="4"></div>
              <div class="inner-game-square f" data-game-index="2" data-subgame-index="5"></div>
              <div class="inner-game-square g" data-game-index="2" data-subgame-index="6"></div>
              <div class="inner-game-square h" data-game-index="2" data-subgame-index="7"></div>
              <div class="inner-game-square i" data-game-index="2" data-subgame-index="8"></div>
            </div>
          </div>
          <div id="inner-game-D" class="inner-game d">
            <div class="inner-game-container">
              <div class="inner-game-square a" data-game-index="3" data-subgame-index="0"></div>
              <div class="inner-game-square b" data-game-index="3" data-subgame-index="1"></div>
              <div class="inner-game-square c" data-game-index="3" data-subgame-index="2"></div>
              <div class="inner-game-square d" data-game-index="3" data-subgame-index="3"></div>
              <div class="inner-game-square e" data-game-index="3" data-subgame-index="4"></div>
              <div class="inner-game-square f" data-game-index="3" data-subgame-index="5"></div>
              <div class="inner-game-square g" data-game-index="3" data-subgame-index="6"></div>
              <div class="inner-game-square h" data-game-index="3" data-subgame-index="7"></div>
              <div class="inner-game-square i" data-game-index="3" data-subgame-index="8"></div>
            </div>
          </div>
          <div id="inner-game-E" class="inner-game e">
            <div class="inner-game-container">        
              <div class="inner-game-square a" data-game-index="4" data-subgame-index="0"></div>
              <div class="inner-game-square b" data-game-index="4" data-subgame-index="1"></div>
              <div class="inner-game-square c" data-game-index="4" data-subgame-index="2"></div>
              <div class="inner-game-square d" data-game-index="4" data-subgame-index="3"></div>
              <div class="inner-game-square e" data-game-index="4" data-subgame-index="4"></div>
              <div class="inner-game-square f" data-game-index="4" data-subgame-index="5"></div>
              <div class="inner-game-square g" data-game-index="4" data-subgame-index="6"></div>
              <div class="inner-game-square h" data-game-index="4" data-subgame-index="7"></div>
              <div class="inner-game-square i" data-game-index="4" data-subgame-index="8"></div>
            </div>
          </div>
          <div id="inner-game-F" class="inner-game f">
            <div class="inner-game-container">
              <div class="inner-game-square a" data-game-index="5" data-subgame-index="0"></div>
              <div class="inner-game-square b" data-game-index="5" data-subgame-index="1"></div>
              <div class="inner-game-square c" data-game-index="5" data-subgame-index="2"></div>
              <div class="inner-game-square d" data-game-index="5" data-subgame-index="3"></div>
              <div class="inner-game-square e" data-game-index="5" data-subgame-index="4"></div>
              <div class="inner-game-square f" data-game-index="5" data-subgame-index="5"></div>
              <div class="inner-game-square g" data-game-index="5" data-subgame-index="6"></div>
              <div class="inner-game-square h" data-game-index="5" data-subgame-index="7"></div>
              <div class="inner-game-square i" data-game-index="5" data-subgame-index="8"></div>
            </div>
          </div>
          <div id="inner-game-G" class="inner-game g">
            <div class="inner-game-container">
              <div class="inner-game-square a" data-game-index="6" data-subgame-index="0"></div>
              <div class="inner-game-square b" data-game-index="6" data-subgame-index="1"></div>
              <div class="inner-game-square c" data-game-index="6" data-subgame-index="2"></div>
              <div class="inner-game-square d" data-game-index="6" data-subgame-index="3"></div>
              <div class="inner-game-square e" data-game-index="6" data-subgame-index="4"></div>
              <div class="inner-game-square f" data-game-index="6" data-subgame-index="5"></div>
              <div class="inner-game-square g" data-game-index="6" data-subgame-index="6"></div>
              <div class="inner-game-square h" data-game-index="6" data-subgame-index="7"></div>
              <div class="inner-game-square i" data-game-index="6" data-subgame-index="8"></div>
            </div>
          </div>
          <div id="inner-game-H" class="inner-game h">
            <div class="inner-game-container">
              <div class="inner-game-square a" data-game-index="7" data-subgame-index="0"></div>
              <div class="inner-game-square b" data-game-index="7" data-subgame-index="1"></div>
              <div class="inner-game-square c" data-game-index="7" data-subgame-index="2"></div>
              <div class="inner-game-square d" data-game-index="7" data-subgame-index="3"></div>
              <div class="inner-game-square e" data-game-index="7" data-subgame-index="4"></div>
              <div class="inner-game-square f" data-game-index="7" data-subgame-index="5"></div>
              <div class="inner-game-square g" data-game-index="7" data-subgame-index="6"></div>
              <div class="inner-game-square h" data-game-index="7" data-subgame-index="7"></div>
              <div class="inner-game-square i" data-game-index="7" data-subgame-index="8"></div>
            </div>
          </div>
          <div id="inner-game-I" class="inner-game i">
            <div class="inner-game-container">
              <div class="inner-game-square a" data-game-index="8" data-subgame-index="0"></div>
              <div class="inner-game-square b" data-game-index="8" data-subgame-index="1"></div>
              <div class="inner-game-square c" data-game-index="8" data-subgame-index="2"></div>
              <div class="inner-game-square d" data-game-index="8" data-subgame-index="3"></div>
              <div class="inner-game-square e" data-game-index="8" data-subgame-index="4"></div>
              <div class="inner-game-square f" data-game-index="8" data-subgame-index="5"></div>
              <div class="inner-game-square g" data-game-index="8" data-subgame-index="6"></div>
              <div class="inner-game-square h" data-game-index="8" data-subgame-index="7"></div>
              <div class="inner-game-square i" data-game-index="8" data-subgame-index="8"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="info">
      Dark Mode:
      <label class="switch">
        <input id="theme-input" type="checkbox" onchange="setTheme(this)">
        <span class="slider round"></span>
      </label>
      <p>Next player:</p>
      <span id="next-player"><img style="width: 100%; height: 100%" src="img/nought.png"></span>
    </div>
    <a class="github-fork-ribbon" href="https://github.com/nunogoncalves/TicTacToe-Ultimate" data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a>

    <script>

      const players = {
        noughts: "O",
        crosses: "X"
      }

      const gameState = {
        open: "open",
        tie: "tie",
        X: players.crosses,
        O: players.noughts
      }

      const winningCombinations = [
        // lines
        [0, 1, 2],
        [3, 4, 5],
        [6, 7, 8],
        // columns
        [0, 3, 6],
        [1, 4, 7],
        [2, 5, 8],
        // diagonals
        [0, 4, 8],
        [2, 4, 6],
      ]

      function SubGame() {
        return {

          state: gameState.open,

          squares: [
            "", "", "",
            "", "", "",
            "", "", "",
          ],

          canPlayIn: function(square) {
            return this.squares[square] == "" && this.state == gameState.open
          },

          playIn: function(square, player) {
            if (this.canPlayIn(square)) {
              this.squares[square] = player;
              this.updateGameState()
            } else {
              print("Can't play here!")
            }
          },

          updateGameState: function() {
            winningCombinations.find(combination => {
              if (this.areAllSquaresEqual(combination) && this.hasWinner() == false) {
                // Winner!
                print("Inner winner!" + this.squares)
                this.state = this.squares[combination[0]]
                return true
              }
              return false
            })

            if (this.state == gameState.open) {
              if (winningCombinations.every(combination => this.tieIn(combination))) {
                // Tie!
                this.state = gameState.tie
              }
            }
          },

          hasWinner: function() {
            return this.state == gameState.O || this.state == gameState.X
          },

          areAllSquaresEqual: function(combination) {
            return combination.every(i => this.squares[i] == this.squares[combination[0]]) && this.squares[combination[0]] != ""
          },

          tieIn: function(combination) {
            return (this.areAllSquaresEqual(combination) == false) && (this.anyOpen(combination) == false)
          },

          anyOpen: function(combination) {
            return combination.some(i => this.squares[i] == "")
          },

          squares_descr: function() {
            var line1 = this.squares.slice(0, 3).map(square => { return (square == "" ? "-" : square) })
            var line2 = this.squares.slice(3, 6).map(square => { return (square == "" ? "-" : square) })
            var line3 = this.squares.slice(6, 9).map(square => { return (square == "" ? "-" : square) })
            return `\n${line1}\n${line2}\n${line3}`
          }
        }
      }

      Game = {

        state: gameState.open,

        innerGames: [
          SubGame(), SubGame(), SubGame(),
          SubGame(), SubGame(), SubGame(),
          SubGame(), SubGame(), SubGame(),
        ],

        availableToPlayNext: [
          0, 1, 2,
          3, 4, 5,
          6, 7, 8
        ],
        
        nextPlayer: players.noughts,

        canPlayIn: function(game, subgame) {
          return this.availableToPlayNext.includes(game) && this.innerGames[game].canPlayIn(subgame)
        },

        playIn: function(game, subgame, player) {
          this.innerGames[game].playIn(subgame, player)
          this.updateGameState(subgame)
        },

        updateGameState: function(subgame) {
          winningCombinations.find(combination => {
            if (this.areAllSquaresEqual(combination)) {
                // Winner!
                print("main winner!")
                this.state = this.innerGames[combination[0]].state
                this.availableToPlayNext = []
                return true
              }
              return false
            }
          )

          if (this.state == gameState.open) {
            if (winningCombinations.every(combination => this.tieIn(combination))) {
                // Tie!
                this.state = gameState.tie
            }
          }
          
          if (this.availableToPlayNext.length == 0) { return }

          // Where can we play next
          if (this.innerGames[subgame].state == gameState.open) {
            this.availableToPlayNext = [subgame]
          } else {
            this.availableToPlayNext = [0, 1, 2, 3, 4, 5, 6, 7, 8]
              .filter(index => this.innerGames[index].state == gameState.open)
          }
        },

        areAllSquaresEqual: function(combination) {
          return combination.every(i => {
            return this.innerGames[i].state == this.innerGames[combination[0]].state }
          ) && this.innerGames[combination[0]].state != gameState.open
          && this.innerGames[combination[0]].state != gameState.tie
        },

        tieIn: function(combination) {
          return (this.areAllSquaresEqual(combination) == false) && (this.anyOpen(combination) == false)
        },

        anyOpen: function(combination) {
          return combination.some(i => this.innerGames[i].state == gameState.open)
        },

        updateUI: function() {
          let allsubGamesElements = Array.from(document.getElementsByClassName("inner-game-container"))
          allsubGamesElements.forEach(element => element.classList.remove("can-play-here-only"))

          this.availableToPlayNext.forEach(subgameIndex => { 
            allsubGamesElements[subgameIndex].classList.add("can-play-here-only")
          })

          let allIndexes = [0, 1, 2, 3, 4, 5, 6, 7, 8]
          allIndexes.forEach(index => {
            if (this.innerGames[index].hasWinner()) {
              let image = this.innerGames[index].state == gameState.O ? "nought" : "cross"
              let winner = Array.from(allsubGamesElements[index].getElementsByClassName("winner"))
              if (winner.length > 0) {
                winner[0].remove()
              }
              allsubGamesElements[index].innerHTML = allsubGamesElements[index].innerHTML + `
                <div class="winner">
                  <img src="img/${image}.png" class="won">
                </div>
                `              
            } else if (this.innerGames[index].state == gameState.tie) {
              allsubGamesElements[index].innerHTML = allsubGamesElements[index].innerHTML + `
                <div class="tie"></div>
              `
            }
          })
        }
      }

      debug = {
        elementIn: function(game, innergame) {
          return document
            .getElementsByClassName("inner-game")[game]
            .getElementsByClassName("inner-game-square")[innergame]
        },

        setTie: function() {
          [
            [0, 0],
            [0, 1],
            [1, 0],
            [0, 2],
            [2, 0],
            [0, 3],
            [3, 4],
            [4, 0],
            [0, 6],
            [6, 0],
            [0, 4],
            [4, 5],
            [5, 0],
            [0, 8],
            [8, 0],
            [0, 7],
            [7, 3],
            [3, 0],
            [0, 5],
          ]
            .forEach(items => {
            playIn(items[0], items[1], this.elementIn(items[0], items[1])); 
          })
        },

        centerWin: function() {
          [
            [4, 3],
            [3, 4],
            [4, 5],
            [5, 4],
          ]
            .forEach(items => {
            playIn(items[0], items[1], this.elementIn(items[0], items[1])); 
          })
        }
      }

      game = Game;

      function print(object) { console.log(object) }

      function clicked(event) { 
        let element = event.target
        let data = element.dataset
        let gameIndex = parseInt(data.gameIndex)
        let innerGameIndex = parseInt(data.subgameIndex)
        playIn(gameIndex, innerGameIndex, element)
      }

      function playIn(gameIndex, innerGameIndex, element) {
        if (game.canPlayIn(gameIndex, innerGameIndex)) {
          var image = game.nextPlayer == players.noughts ? "nought" : "cross"
          game.playIn(gameIndex, innerGameIndex, game.nextPlayer)
          let nextPlayerImage = `<img style="width: 100%; height: 100%" src="img/${image}.png">`
          element.innerHTML = nextPlayerImage
          game.updateUI()
          game.nextPlayer = game.nextPlayer == players.noughts ? players.crosses : players.noughts
          image = game.nextPlayer == players.noughts ? "nought" : "cross"
          document.getElementById("next-player").innerHTML = `<img style="width: 200px; height: 200px" src="img/${image}.png">`

        }
      }

      function setTheme(element) {
        let rootStyle = document.documentElement.style
        if (element.checked) {
          localStorage.setItem('ttt-theme','dark');

          rootStyle.setProperty("--main-bg-color", "black")
          rootStyle.setProperty("--text-color", "white")
          rootStyle.setProperty("--play-here-color", "#32485e")
          rootStyle.setProperty("--main-game-division-color", "#4f78ff")
          rootStyle.setProperty("--inner-game-division-color", "#30961e")
          rootStyle.setProperty("--winner-bg-color", "rgba(0, 0, 0, 0.8)")
          rootStyle.setProperty("--tie-bg-image", "url('img/scribble-white.png')")
        } else {
          localStorage.setItem('ttt-theme','light');

          rootStyle.setProperty("--main-bg-color", "white")
          rootStyle.setProperty("--text-color", "black")
          rootStyle.setProperty("--play-here-color", "#D1E8FF")
          rootStyle.setProperty("--main-game-division-color", "#5A7FFA")
          rootStyle.setProperty("--inner-game-division-color", "#33F211")
          rootStyle.setProperty("--winner-bg-color", "rgba(255, 255, 255, 0.8)")
          rootStyle.setProperty("--tie-bg-image", "url('img/scribble.png')")
        }
      }

      (function() {

        let theme = localStorage.getItem('ttt-theme');
        if (theme == "dark") {
          document.getElementById("theme-input").click()
        } 

        elements = Array.from(document.getElementsByClassName("inner-game-square"))
        elements.forEach(element => element.onclick = clicked)
      })()
    </script>
  </body>
</html>